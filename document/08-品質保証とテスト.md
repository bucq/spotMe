# 08 - 品質保証とテスト

> [[07-UI-UX設計]] | [[BondPoint設計書]] | Next: [[09-セキュリティとプライバシー]]

## 🧪 テスト戦略

### テストピラミッド
```
         🔺 E2E Tests (10%)
        ────────────────────
       🔺🔺 Integration Tests (20%)
      ────────────────────────────
     🔺🔺🔺 Unit Tests (70%)
    ────────────────────────────────
```

### 品質目標
- **コードカバレッジ**: 80%以上
- **E2Eテスト**: 主要フロー100%
- **パフォーマンス**: 2秒以内のレスポンス
- **可用性**: 99.9%稼働率

---

## 🐍 バックエンドテスト

### 単体テスト（70%）

#### テストフレームワーク
- **pytest**: メインテストフレームワーク
- **pytest-asyncio**: 非同期テスト
- **pytest-cov**: カバレッジ測定
- **factory_boy**: テストデータファクトリ

#### テスト例：ステータス更新API

```python
import pytest
from fastapi.testclient import TestClient
from app.main import app
from app.models import UserStatus

client = TestClient(app)

class TestStatusAPI:
    """ステータス更新APIのテスト"""

    @pytest.fixture
    def auth_headers(self, test_user):
        """認証ヘッダーの準備"""
        token = create_access_token(test_user.id)
        return {"Authorization": f"Bearer {token}"}

    def test_update_status_success(self, auth_headers, test_event):
        """正常なステータス更新"""
        payload = {
            "status_type": "ON_TRAIN",
            "custom_message": "山手線で向かいます",
            "latitude": 35.681236,
            "longitude": 139.767125
        }
        
        response = client.post(
            f"/api/v1/events/{test_event.id}/status",
            json=payload,
            headers=auth_headers
        )
        
        assert response.status_code == 200
        data = response.json()
        assert data["status_type"] == "ON_TRAIN"
        assert data["custom_message"] == "山手線で向かいます"
        assert "estimated_arrival_time" in data

    def test_update_status_invalid_type(self, auth_headers, test_event):
        """無効なステータスタイプ"""
        payload = {"status_type": "INVALID_STATUS"}
        
        response = client.post(
            f"/api/v1/events/{test_event.id}/status",
            json=payload,
            headers=auth_headers
        )
        
        assert response.status_code == 400
        assert "VALIDATION_ERROR" in response.json()["error"]["code"]

    def test_update_status_unauthorized(self, test_event):
        """認証なしアクセス"""
        payload = {"status_type": "ON_TRAIN"}
        
        response = client.post(
            f"/api/v1/events/{test_event.id}/status",
            json=payload
        )
        
        assert response.status_code == 401

    @pytest.mark.asyncio
    async def test_firestore_sync(self, test_user, test_event):
        """Firestoreとの同期テスト"""
        status_data = {
            "status_type": "ARRIVED",
            "user_id": test_user.id
        }
        
        # PostgreSQLへの保存
        await update_status_in_postgres(test_event.id, test_user.id, status_data)
        
        # Firestoreへの同期確認
        firestore_data = await get_status_from_firestore(test_event.id, test_user.id)
        assert firestore_data["status_type"] == "ARRIVED"
```

### 統合テスト（20%）

#### データベース統合テスト

```python
class TestDatabaseIntegration:
    """データベース統合テスト"""

    @pytest.mark.asyncio
    async def test_status_update_flow(self, test_db, test_user, test_event):
        """ステータス更新の完全フロー"""
        # 1. 初期状態確認
        initial_status = await get_user_status(test_event.id, test_user.id)
        assert initial_status is None
        
        # 2. ステータス作成
        new_status = await create_user_status(
            event_id=test_event.id,
            user_id=test_user.id,
            status_type="HOME_DEPARTED"
        )
        assert new_status.status_type == "HOME_DEPARTED"
        
        # 3. ステータス更新
        updated_status = await update_user_status(
            event_id=test_event.id,
            user_id=test_user.id,
            status_data={"status_type": "ON_TRAIN"}
        )
        assert updated_status.status_type == "ON_TRAIN"
        
        # 4. 履歴確認
        status_history = await get_status_history(test_event.id, test_user.id)
        assert len(status_history) == 2
```

### 負荷テスト

#### Locust による負荷テスト

```python
from locust import HttpUser, task, between

class BondPointUser(HttpUser):
    wait_time = between(1, 3)
    
    def on_start(self):
        """テスト開始時の認証"""
        response = self.client.post("/api/v1/auth/login", json={
            "phone_number": "+81-90-1234-5678",
            "password": "test_password"
        })
        self.token = response.json()["access_token"]
        self.headers = {"Authorization": f"Bearer {self.token}"}
    
    @task(3)
    def view_events(self):
        """イベント一覧取得（高頻度）"""
        self.client.get("/api/v1/events", headers=self.headers)
    
    @task(2)
    def view_status(self):
        """ステータス確認（中頻度）"""
        event_id = "test-event-id"
        self.client.get(f"/api/v1/events/{event_id}/statuses", headers=self.headers)
    
    @task(1)
    def update_status(self):
        """ステータス更新（低頻度）"""
        event_id = "test-event-id"
        self.client.post(
            f"/api/v1/events/{event_id}/status",
            json={"status_type": "ON_TRAIN"},
            headers=self.headers
        )
```

#### 負荷テスト目標

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| **同時ユーザー数** | 1,000人 | Locust |
| **レスポンス時間** | P95 < 500ms | Cloud Monitoring |
| **スループット** | 100 req/sec | Locust |
| **エラー率** | < 1% | アプリケーションログ |

---

## 📱 フロントエンドテスト

### 単体テスト（Jest + React Testing Library）

#### コンポーネントテスト例

```typescript
import React from 'react';
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import StatusSelector from '../components/StatusSelector';

describe('StatusSelector', () => {
  const mockOnStatusChange = jest.fn();
  
  beforeEach(() => {
    mockOnStatusChange.mockClear();
  });

  test('プリセットステータスが表示される', () => {
    const { getByText } = render(
      <StatusSelector onStatusChange={mockOnStatusChange} />
    );
    
    // 各ステータスボタンの存在確認
    expect(getByText('🏠 未出発')).toBeTruthy();
    expect(getByText('🚶 家を出た')).toBeTruthy();
    expect(getByText('🚉 駅到着')).toBeTruthy();
    expect(getByText('🚃 電車乗車中')).toBeTruthy();
  });

  test('ステータス選択時にコールバックが呼ばれる', async () => {
    const { getByText } = render(
      <StatusSelector onStatusChange={mockOnStatusChange} />
    );
    
    // 「電車乗車中」をタップ
    fireEvent.press(getByText('🚃 電車乗車中'));
    
    await waitFor(() => {
      expect(mockOnStatusChange).toHaveBeenCalledWith({
        status_type: 'ON_TRAIN',
        status_display: '🚃 電車乗車中'
      });
    });
  });

  test('カスタムメッセージ入力モーダルが開く', async () => {
    const { getByText, getByPlaceholderText } = render(
      <StatusSelector onStatusChange={mockOnStatusChange} />
    );
    
    // カスタムボタンをタップ
    fireEvent.press(getByText('💬 カスタムメッセージ'));
    
    // モーダルの表示確認
    await waitFor(() => {
      expect(getByPlaceholderText('メッセージを入力...')).toBeTruthy();
    });
  });
});
```

### E2Eテスト（Detox）

#### 主要フローのE2Eテスト

```typescript
describe('ステータス更新フロー', () => {
  beforeAll(async () => {
    await device.launchApp();
  });

  beforeEach(async () => {
    await device.reloadReactNative();
  });

  test('ログイン→イベント詳細→ステータス更新', async () => {
    // 1. ログイン
    await element(by.id('phone-input')).typeText('+81-90-1234-5678');
    await element(by.id('login-button')).tap();
    
    // SMS認証コード入力（テスト環境では固定値）
    await element(by.id('code-input')).typeText('123456');
    await element(by.id('verify-button')).tap();
    
    // 2. ホーム画面でイベントをタップ
    await waitFor(element(by.id('event-card-0'))).toBeVisible().withTimeout(5000);
    await element(by.id('event-card-0')).tap();
    
    // 3. イベント詳細画面でステータスタブをタップ
    await element(by.id('status-tab')).tap();
    
    // 4. 「電車乗車中」ステータスを選択
    await element(by.id('status-ON_TRAIN')).tap();
    
    // 5. ステータス更新の確認
    await waitFor(element(by.text('🚃 電車乗車中'))).toBeVisible();
    
    // 6. 他ユーザーの画面でも反映されることを確認
    // （テスト環境では複数デバイスシミュレーション）
  });

  test('位置情報共有のON/OFF', async () => {
    // 事前条件：ログイン済み、イベント詳細画面
    await navigateToEventStatus();
    
    // 位置情報共有をON
    await element(by.id('location-toggle')).tap();
    
    // 権限確認ダイアログで許可
    await element(by.text('許可')).tap();
    
    // 位置情報が共有されていることを確認
    await waitFor(element(by.id('location-shared-indicator'))).toBeVisible();
    
    // 位置情報共有をOFF
    await element(by.id('location-toggle')).tap();
    
    // 確認ダイアログでOFFを選択
    await element(by.text('共有を停止')).tap();
    
    // 位置情報が非表示になることを確認
    await waitFor(element(by.id('location-shared-indicator'))).not.toBeVisible();
  });
});
```

---

## 🔄 CI/CD パイプライン

### GitHub Actions設定

```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Run linting
      run: |
        ruff check .
        mypy .
    
    - name: Run tests
      run: |
        pytest --cov=app --cov-report=xml
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost/test_db
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3

  frontend-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linting
      run: npm run lint
    
    - name: Run type checking
      run: npm run type-check
    
    - name: Run unit tests
      run: npm run test:unit
    
    - name: Run E2E tests
      run: npm run test:e2e

  deploy-staging:
    needs: [backend-test, frontend-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Cloud Run (Staging)
      run: |
        gcloud run deploy bondpoint-api-staging \
          --source . \
          --region asia-northeast1 \
          --project ${{ secrets.GCP_PROJECT_ID }}
```

### 品質ゲート

| ステージ | 必須条件 | 失敗時の対応 |
|----------|----------|------------|
| **Lint** | エラー0件 | 自動修正可能なものは修正 |
| **Unit Tests** | カバレッジ80%以上 | テスト追加 |
| **Integration Tests** | 成功率100% | 根本原因調査 |
| **E2E Tests** | 主要フロー100%成功 | 手動確認後修正 |
| **Security Scan** | 高リスク脆弱性0件 | 依存関係更新 |

---

## 📊 品質メトリクス

### コードカバレッジ目標

| レイヤー | 目標カバレッジ | 測定ツール |
|----------|-------------|----------|
| **API層** | 90%以上 | pytest-cov |
| **ビジネスロジック層** | 95%以上 | pytest-cov |
| **データ層** | 80%以上 | pytest-cov |
| **フロントエンド** | 75%以上 | Jest |

### 継続的品質監視

#### SonarQube設定
```properties
# sonar-project.properties
sonar.projectKey=bondpoint
sonar.projectName=BondPoint
sonar.projectVersion=1.0

# Python設定
sonar.python.coverage.reportPaths=coverage.xml
sonar.python.xunit.reportPath=test-reports/*.xml

# TypeScript設定
sonar.typescript.lcov.reportPaths=coverage/lcov.info

# 品質ゲート
sonar.qualitygate.wait=true
```

### パフォーマンステスト

#### 目標パフォーマンス

| API | 目標レスポンス時間 | 最大レスポンス時間 |
|-----|---------------|------------------|
| **ステータス更新** | < 200ms | < 500ms |
| **ステータス取得** | < 100ms | < 300ms |
| **イベント一覧** | < 150ms | < 400ms |
| **ユーザー認証** | < 300ms | < 800ms |

#### 継続的パフォーマンス監視

```python
# performance_test.py
def test_status_update_performance():
    """ステータス更新のパフォーマンステスト"""
    start_time = time.time()
    
    response = client.post("/api/v1/events/test-event/status", 
                          json={"status_type": "ON_TRAIN"})
    
    end_time = time.time()
    response_time = (end_time - start_time) * 1000  # ms
    
    assert response.status_code == 200
    assert response_time < 200  # 200ms以下
```

---

## 🐛 バグ管理プロセス

### 重要度分類

| 重要度 | 説明 | 対応期限 | 例 |
|--------|------|----------|----|
| **Critical** | サービス停止 | 2時間以内 | ログイン不可、データ消失 |
| **High** | 主要機能停止 | 24時間以内 | ステータス更新不可 |
| **Medium** | 一部機能に影響 | 1週間以内 | 位置情報表示不正 |
| **Low** | 軽微な問題 | 次回リリース | UI表示崩れ |

### バグレポートテンプレート

```markdown
## バグレポート

### 基本情報
- **発見日時**: 2025-09-29 15:30
- **報告者**: 田中
- **重要度**: High
- **環境**: iOS 17.1 / iPhone 14

### 現象
- **期待する動作**: ステータス更新後、他ユーザーに即座反映
- **実際の動作**: 5分以上反映されない
- **再現率**: 3/5回

### 再現手順
1. ユーザーAがステータスを「電車乗車中」に更新
2. ユーザーBの画面で確認
3. 5分経っても更新されない

### 関連ログ・スクリーンショット
- Cloud Logging: [リンク]
- スクリーンショット: [添付]

### 影響範囲
- **影響ユーザー**: 全ユーザー
- **回避策**: アプリ再起動で解決
```

---

**Next**: [[09-セキュリティとプライバシー]] - セキュリティ設計と個人情報保護