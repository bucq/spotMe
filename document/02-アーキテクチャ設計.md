# 02 - アーキテクチャ設計

> [[01-MVP概要と機能]] | [[spotMe設計書]] | Next: [[03-技術スタック]]

## 🏗️ GCP サーバーレス アーキテクチャ

### システム構成図

```
[モバイルアプリ (React Native)]
    │
    ├─── 🌐 REST API ────────────> [Cloud Run - FastAPI]
    │                                      │
    │                                      ├──> [Cloud SQL - PostgreSQL]
    │                                      ├──> [Secret Manager]
    │                                      └──> [Cloud Storage]
    │
    ├─── ⚡ リアルタイムDB ──────> [Cloud Firestore]
    │                                      │
    │                                      └──> リアルタイムステータス同期
    │
    ├─── 🔔 プッシュ通知 ────────> [Firebase Cloud Messaging]
    │
    └─── 📱 画像アップロード ────> [Cloud Storage]

[🔧 バックグラウンド処理]
    └──> [Cloud Functions (第2世代)]
         ├── 定期的な通知送信
         ├── イベント終了後のクリーンアップ
         └── 位置情報の自動OFF処理
```

---

## 🚀 使用 GCP サービス詳細

### Cloud Run（FastAPI ホスティング）

**役割**: RESTful API サーバー

| 設定項目 | 開発環境 | 本番環境 |
|----------|----------|----------|
| **リージョン** | asia-northeast1（東京） | asia-northeast1（東京） |
| **メモリ** | 512MB | 1GB |
| **CPU** | 1vCPU | 1vCPU |
| **同時実行数** | 80リクエスト/インスタンス | 80リクエスト/インスタンス |
| **スケーリング** | 0→10インスタンス | 0→100インスタンス |
| **最小インスタンス** | 0（コスト削減） | 1（レスポンス向上） |

**コールドスタート対策**:
- 最小インスタンス数設定
- 軽量な依存関係
- FastAPI の高速起動

---

### Cloud SQL（PostgreSQL 15）

**役割**: メインデータベース

| 設定項目 | 開発環境 | 本番環境 |
|----------|----------|----------|
| **マシンタイプ** | db-f1-micro | db-n1-standard-1 |
| **ストレージ** | 10GB SSD | 20GB SSD（自動拡張） |
| **バックアップ** | 週1回 | 毎日（午前3時） |
| **ネットワーク** | Public IP | Private IP |
| **高可用性** | 無効 | 有効（マルチゾーン） |

**接続最適化**:
- **接続プール**: SQLAlchemy + asyncpg
- **接続数制限**: 10（開発）→ 50（本番）
- **タイムアウト**: 30秒

---

### Cloud Firestore

**役割**: リアルタイムステータス同期

| 設定項目 | 値 |
|----------|-----|
| **モード** | Native Mode |
| **リージョン** | asia-northeast1 |
| **セキュリティルール** | 認証済みユーザーのみ |

**データ構造**:
```
events/{eventId}/
├── statuses/{userId}
│   ├── status_type: string
│   ├── custom_message: string?
│   ├── user_name: string
│   ├── updated_at: timestamp
│   └── is_on_schedule: boolean
│
└── messages/{messageId}
    ├── user_id: string
    ├── user_name: string
    ├── content: string
    ├── type: "text" | "status"
    └── created_at: timestamp
```

**パフォーマンス最適化**:
- **インデックス**: user_id, updated_at
- **リアルタイムリスナー**: イベント参加者のみ
- **オフラインキャッシュ**: 自動有効

---

### Cloud Storage

**役割**: ユーザー画像、イベント画像保存

| バケット名 | 用途 | ストレージクラス |
|------------|------|------------------|
| `spotMe-user-images` | プロフィール画像 | Standard |
| `spotMe-event-images` | イベント画像 | Standard |

**ライフサイクル管理**:
- **90日後**: Coldline ストレージに移行
- **1年後**: 削除（ユーザー同意）

**セキュリティ**:
- **署名付きURL**: 一時的なアクセス権
- **画像最適化**: WebP 変換、リサイズ

---

### Cloud Functions（第2世代）

**役割**: バックグラウンドタスク

| Function名 | トリガー | 実行頻度 |
|------------|----------|----------|
| `notification-scheduler` | Cloud Scheduler | イベント1時間前 |
| `location-auto-off` | Cloud Scheduler | イベント終了5時間後 |
| `cleanup-expired-data` | Cloud Scheduler | 毎日午前2時 |
| `status-sync` | Firestore変更 | リアルタイム |

**リソース設定**:
- **メモリ**: 256MB
- **タイムアウト**: 60秒
- **同時実行数**: 10

---

### Secret Manager

**役割**: 機密情報の安全な保管

| シークレット名 | 用途 |
|---------------|------|
| `google-maps-api-key` | Google Maps API |
| `jwt-secret-key` | JWT トークン署名 |
| `firebase-admin-key` | Firebase Admin SDK |
| `database-url` | PostgreSQL 接続文字列 |
| `sms-api-key` | SMS 認証サービス |

**アクセス制御**:
- Cloud Run サービスアカウントのみアクセス可能
- バージョン管理とローテーション機能

---

### Firebase Cloud Messaging

**役割**: プッシュ通知配信

**通知種類**:
- **イベント招待**: 新しいイベントへの招待
- **出欠確認リマインダー**: イベント24時間前
- **ステータス変更**: メンバーの重要な状態変化
- **チャットメッセージ**: グループ内メッセージ

**配信戦略**:
- **トピック配信**: イベント単位でのグループ通知
- **トークン配信**: 個人向け通知
- **バッチ送信**: 効率的な一括配信

---

## ⚖️ アーキテクチャ設計原則

### 1. サーバーレス First
- **自動スケーリング**: 需要に応じた自動リソース調整
- **ペイ・パー・ユース**: 使用した分だけの課金
- **運用負荷軽減**: インフラ管理の最小化

### 2. 責任分離
- **Cloud SQL**: 永続化が必要な重要データ
- **Firestore**: リアルタイム同期が必要なデータ
- **Cloud Storage**: バイナリデータ（画像等）

### 3. セキュリティ by Design
- **Zero Trust**: すべての通信を暗号化
- **最小権限**: 必要最小限のアクセス権限
- **防御多層化**: 複数のセキュリティレイヤー

### 4. パフォーマンス最適化
- **CDN活用**: 静的コンテンツの高速配信
- **キャッシング戦略**: 多層キャッシュ構成
- **接続プール**: データベース接続の効率化

---

## 📊 データフロー

### 1. ステータス更新フロー
```
[ユーザー操作]
    │
    ├── 📱 React Native アプリ
    │   └── POST /api/status/{event_id}
    │
    ├── 🌐 Cloud Run (FastAPI)
    │   ├── JWT 認証検証
    │   ├── データバリデーション
    │   └── Cloud SQL に永続化
    │
    ├── ⚡ Firestore 同期（非同期）
    │   └── リアルタイム配信
    │
    └── 📱 他ユーザーアプリ
        └── リアルタイム受信・UI更新
```

### 2. 位置情報共有フロー
```
[GPS取得] → [暗号化] → [Cloud SQL保存] → [Firestore同期] → [他ユーザー表示]
    ↑                                                              ↓
[プライバシー設定] ←─── [ユーザー制御] ←─── [自動OFF処理] ←─── [Cloud Functions]
```

### 3. プッシュ通知フロー
```
[イベント発生] → [Cloud Functions] → [FCM] → [モバイルデバイス]
      ↑              ↑              ↑            ↓
[Scheduler]    [通知コンテンツ生成]  [配信]    [アプリ起動]
```

---

## 🔄 スケーラビリティ戦略

### ユーザー数別構成

| ユーザー数 | Cloud Run | Cloud SQL | Firestore | 月額コスト |
|------------|-----------|-----------|-----------|------------|
| ~1,000 | 最小構成 | db-f1-micro | 無料枠 | ¥3,000 |
| ~10,000 | 標準構成 | db-n1-standard-1 | 有料プラン | ¥36,000 |
| ~50,000 | 高性能構成 | db-n1-standard-2 | 最適化 | ¥150,000 |

### 水平スケーリング戦略
1. **Cloud Run**: 自動スケーリング（0→100インスタンス）
2. **Cloud SQL**: リードレプリカ追加
3. **Firestore**: シャーディング戦略
4. **CDN**: 地理的分散配信

---

## 🛡️ 可用性・災害復旧

### 可用性目標
- **サービス稼働率**: 99.9%（月間約43分のダウンタイム）
- **データ可用性**: 99.95%
- **RTO**（復旧時間目標）: 4時間
- **RPO**（データ損失許容）: 1時間

### 災害復旧戦略
1. **自動バックアップ**: 日次スナップショット
2. **マルチリージョン**: Firestore のレプリケーション
3. **ヘルスチェック**: 自動障害検知
4. **フェイルオーバー**: 自動切り替え機能

---

**Next**: [[03-技術スタック]] - 2025年最新の技術選定詳細