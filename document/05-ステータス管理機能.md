# 05 - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†æ©Ÿèƒ½

> [[04-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ]] | [[spotMeè¨­è¨ˆæ›¸]] | Next: [[06-APIè¨­è¨ˆ]]

## â­ ã‚³ã‚¢æ©Ÿèƒ½ï¼šè©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†

**spotMe ã®æœ€å¤§ã®å·®åˆ¥åŒ–è¦ç´ **ã§ã‚ã‚‹è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†æ©Ÿèƒ½ã®è¨­è¨ˆè©³ç´°ã€‚å¾“æ¥ã®ã€Œâ—¯æ™‚ã«â—¯â—¯ã§ã€ã¨ã„ã†æ›–æ˜§ãªå¾…ã¡åˆã‚ã›ã‚’ã€**8æ®µéšã®è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç®¡ç†ã€‚

---

## ğŸ¯ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¨®é¡å®šç¾©

### ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ8ç¨®é¡ï¼‰

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ã‚­ãƒ¼ | ã‚¢ã‚¤ã‚³ãƒ³ | èª¬æ˜ | ä½ç½®æƒ…å ± | ä½¿ç”¨å ´é¢ |
|------------|------|----------|------|----------|----------|
| **æœªå‡ºç™º** | `NOT_STARTED` | ğŸ  | ã¾ã å®¶ã«ã„ã‚‹ | ä¸è¦ | æº–å‚™ä¸­ã€ã¾ã æ™‚é–“ãŒã‚ã‚‹ |
| **å®¶ã‚’å‡ºãŸ** | `HOME_DEPARTED` | ğŸš¶ | å®¶ã‚’å‡ºç™ºã—ãŸ | ä»»æ„ | ç§»å‹•é–‹å§‹ã®ãŠçŸ¥ã‚‰ã› |
| **é§…åˆ°ç€** | `STATION_ARRIVED` | ğŸš‰ | æœ€å¯„ã‚Šé§…ã«åˆ°ç€ | ä»»æ„ | é›»è»Šå¾…ã¡ã€ä¹—è»Šäºˆå®š |
| **é›»è»Šä¹—è»Šä¸­** | `ON_TRAIN` | ğŸšƒ | é›»è»Šã«ä¹—ã£ã¦ã„ã‚‹ | ä»»æ„ | ç§»å‹•ä¸­ã€åˆ°ç€äºˆå®šæ™‚åˆ»å…±æœ‰ |
| **ä¹—ã‚Šæ›ãˆä¸­** | `TRANSFERRING` | ğŸ”„ | ä¹—ã‚Šæ›ãˆé§…ã«ã„ã‚‹ | ä»»æ„ | é…å»¶ãƒªã‚¹ã‚¯ã€æ¬¡ã®é›»è»Šå¾…ã¡ |
| **åˆ°ç€é–“è¿‘** | `NEAR_ARRIVAL` | â±ï¸ | ã‚‚ã†ã™ãåˆ°ç€ | ä»»æ„ | ãƒ©ã‚¹ãƒˆ5-10åˆ†ã€æº–å‚™å®Œäº† |
| **åˆ°ç€æ¸ˆã¿** | `ARRIVED` | âœ… | é›†åˆå ´æ‰€ã«åˆ°ç€ | è‡ªå‹•ON | ä»–ãƒ¡ãƒ³ãƒãƒ¼ã‚’å¾…æ©Ÿä¸­ |
| **é…å»¶ä¸­** | `DELAYED` | âš ï¸ | é…ã‚Œã¦ã„ã‚‹ | ä»»æ„ | ãƒˆãƒ©ãƒ–ãƒ«ç™ºç”Ÿã€æ–°ã—ã„åˆ°ç€äºˆå®š |

### ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ã‚­ãƒ¼ | ã‚¢ã‚¤ã‚³ãƒ³ | èª¬æ˜ |
|------------|------|----------|------|
| **ã‚«ã‚¹ã‚¿ãƒ ** | `CUSTOM` | ğŸ’¬ | è‡ªç”±å…¥åŠ›ï¼ˆæœ€å¤§200æ–‡å­—ï¼‰ |

**ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹**:
- ã€Œé›»è»ŠãŒ5åˆ†é…ã‚Œã¦ã¾ã™ğŸ˜­ã€
- ã€Œã‚³ãƒ³ãƒ“ãƒ‹å¯„ã£ã¦ã‹ã‚‰å‘ã‹ã„ã¾ã™ã€
- ã€Œé›¨ã§å°‘ã—é…ããªã‚Šãã†ã§ã™ã€
- ã€Œå…ˆã«å¸­ç¢ºä¿ã—ã¦ã¾ã™ğŸºã€

---

## ğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒ•ãƒ­ãƒ¼

### ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼å›³

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ]
    â”‚
    â”œâ”€â”€ ğŸ“± ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ
    â”‚   â””â”€â”€> ã‚¿ãƒƒãƒ—ã§å³åº§ã«æ›´æ–°
    â”‚
    â””â”€â”€ ğŸ’¬ ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ
        â””â”€â”€> ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
             â”œâ”€â”€ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ï¼ˆæœ€å¤§200æ–‡å­—ï¼‰
             â”œâ”€â”€ ä½ç½®æƒ…å ±å…±æœ‰è¨­å®š
             â””â”€â”€ åˆ°ç€äºˆå®šæ™‚åˆ»è¨­å®š
    â”‚
    â†“
[FastAPI ã‚µãƒ¼ãƒãƒ¼å‡¦ç†]
    â”‚
    â”œâ”€â”€ ğŸ” JWT èªè¨¼æ¤œè¨¼
    â”œâ”€â”€ ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    â”œâ”€â”€ ğŸ—„ï¸ PostgreSQL æ°¸ç¶šåŒ–
    â””â”€â”€ âš¡ Firestore ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
    â”‚
    â†“
[ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é…ä¿¡]
    â”‚
    â”œâ”€â”€ ğŸ“± Firestore Listener â†’ UI æ›´æ–°
    â”œâ”€â”€ ğŸ”” é‡è¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ â†’ ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥
    â””â”€â”€ ğŸ’¬ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ â†’ ãƒãƒ£ãƒƒãƒˆæŠ•ç¨¿
```

### è©³ç´°æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯

```python
async def update_user_status(
    event_id: UUID,
    user_id: UUID,
    status_data: StatusUpdateRequest
):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†"""

    # 1. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    validate_status_update(status_data)

    # 2. PostgreSQL ã«æ°¸ç¶šåŒ–
    db_status = await save_status_to_postgres(
        event_id, user_id, status_data
    )

    # 3. åˆ°ç€äºˆå®šæ™‚åˆ»ã®è‡ªå‹•è¨ˆç®—
    if status_data.status_type in ['ON_TRAIN', 'TRANSFERRING']:
        estimated_time = await calculate_arrival_time(
            event_id, user_id, status_data
        )
        db_status.estimated_arrival_time = estimated_time

    # 4. Firestore ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
    await sync_status_to_firestore(event_id, user_id, db_status)

    # 5. ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ï¼ˆé‡è¦ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã¿ï¼‰
    if status_data.status_type in ['ARRIVED', 'DELAYED']:
        await send_status_notification(event_id, user_id, db_status)

    return db_status
```

---

## âš¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸæˆ¦ç•¥

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

#### 1. æ°¸ç¶šåŒ–å±¤ï¼ˆPostgreSQLï¼‰
- **å½¹å‰²**: é‡è¦ãƒ‡ãƒ¼ã‚¿ã®ç¢ºå®Ÿãªä¿å­˜
- **æ›´æ–°é »åº¦**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚
- **ä¿æŒæœŸé–“**: æ°¸ç¶šåŒ–ï¼ˆ1å¹´å¾Œã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰

#### 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å±¤ï¼ˆFirestoreï¼‰
- **å½¹å‰²**: å³åº§ã®é…ä¿¡ã¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
- **æ›´æ–°é »åº¦**: å³æ™‚åŒæœŸ
- **ä¿æŒæœŸé–“**: ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†å¾Œ24æ™‚é–“

#### 3. åŒæœŸã‚¿ã‚¤ãƒŸãƒ³ã‚°

| æ“ä½œ | PostgreSQL | Firestore | é…å»¶æ™‚é–“ |
|------|------------|-----------|----------|
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ | å³æ™‚ | å³æ™‚ | < 100ms |
| ä½ç½®æƒ…å ±æ›´æ–° | 30ç§’é–“éš” | å³æ™‚ | < 200ms |
| ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | å³æ™‚ | å³æ™‚ | < 100ms |
| åˆ°ç€äºˆå®šæ™‚åˆ» | å³æ™‚ | å³æ™‚ | < 100ms |

### ç«¶åˆåˆ¶å¾¡

```python
async def handle_concurrent_updates(event_id: UUID, user_id: UUID):
    """åŒæ™‚æ›´æ–°ã®ç«¶åˆåˆ¶å¾¡"""

    # æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼ˆupdated_at ã«ã‚ˆã‚‹åˆ¶å¾¡ï¼‰
    current_status = await get_current_status(event_id, user_id)

    if status_data.last_updated < current_status.updated_at:
        raise ConflictError("Status was updated by another request")

    # æœ€æ–°ã® updated_at ã§æ›´æ–°
    status_data.updated_at = datetime.utcnow()
    return await update_status(status_data)
```

---

## ğŸ“ ä½ç½®æƒ…å ±ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼åˆ¶å¾¡

### ä½ç½®æƒ…å ±å…±æœ‰ãƒ«ãƒ¼ãƒ«

| ã‚¤ãƒ™ãƒ³ãƒˆçŠ¶æ³ | ä½ç½®æƒ…å ±å…±æœ‰ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º | åˆ¶å¾¡æ–¹æ³• |
|------------|------------|--------------|----------|
| **é–‹å§‹2æ™‚é–“å‰ã¾ã§** | OFF | ã€Œæœªå‡ºç™ºã€ã®ã¿ | æ™‚é–“ãƒ™ãƒ¼ã‚¹è‡ªå‹•åˆ¶å¾¡ |
| **é–‹å§‹2æ™‚é–“å‰ã€œçµ‚äº†** | ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠå¯ | è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä»»æ„è¨­å®š |
| **ã€Œåˆ°ç€æ¸ˆã¿ã€é¸æŠæ™‚** | è‡ªå‹•ONï¼ˆé«˜ç²¾åº¦ï¼‰ | æ­£ç¢ºãªä½ç½®è¡¨ç¤º | ã‚·ã‚¹ãƒ†ãƒ è‡ªå‹•åˆ¶å¾¡ |
| **çµ‚äº†5æ™‚é–“å¾Œ** | å¼·åˆ¶OFF | è¡¨ç¤ºçµ‚äº† | è‡ªå‹•å‰Šé™¤å‡¦ç† |

### ä½ç½®æƒ…å ±ç²¾åº¦ãƒ¬ãƒ™ãƒ«

```python
class LocationPrecision(Enum):
    OFF = "OFF"           # ä½ç½®æƒ…å ±ãªã—
    LOW = "LOW"           # åŒºãƒ¬ãƒ™ãƒ«ï¼ˆåŠå¾„500mï¼‰
    MEDIUM = "MEDIUM"     # é§…ãƒ¬ãƒ™ãƒ«ï¼ˆåŠå¾„100mï¼‰
    HIGH = "HIGH"         # GPSæ­£ç¢ºä½ç½®ï¼ˆÂ±10mï¼‰

class LocationPrivacy:
    @staticmethod
    def adjust_precision(lat: float, lng: float, precision: LocationPrecision):
        """ç²¾åº¦ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ä½ç½®æƒ…å ±ã‚’èª¿æ•´"""
        if precision == LocationPrecision.OFF:
            return None, None
        elif precision == LocationPrecision.LOW:
            # åŒºãƒ¬ãƒ™ãƒ«ã«ä¸¸ã‚ã‚‹ï¼ˆç´„500mç²¾åº¦ï¼‰
            return round(lat, 2), round(lng, 2)
        elif precision == LocationPrecision.MEDIUM:
            # é§…ãƒ¬ãƒ™ãƒ«ã«ä¸¸ã‚ã‚‹ï¼ˆç´„100mç²¾åº¦ï¼‰
            return round(lat, 3), round(lng, 3)
        else:  # HIGH
            # GPSæ­£ç¢ºãªä½ç½®
            return lat, lng
```

### è‡ªå‹•ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼åˆ¶å¾¡

```python
async def auto_privacy_control():
    """ä½ç½®æƒ…å ±ã®è‡ªå‹•ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼åˆ¶å¾¡"""

    current_time = datetime.utcnow()

    # ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†5æ™‚é–“å¾Œã®ä½ç½®æƒ…å ±è‡ªå‹•å‰Šé™¤
    expired_events = await get_events_expired_5hours()
    for event in expired_events:
        await delete_location_data(event.id)
        await log_privacy_action(event.id, "AUTO_DELETE_LOCATION")

    # ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹2æ™‚é–“å‰ã®ä½ç½®æƒ…å ±è‡ªå‹•OFF
    upcoming_events = await get_events_starting_2hours()
    for event in upcoming_events:
        await disable_location_sharing(event.id)
        await log_privacy_action(event.id, "AUTO_DISABLE_LOCATION")
```

---

## ğŸ¨ UI/UX ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è¨­è¨ˆ

### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠUI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¾åœ¨ã®çŠ¶æ³ã‚’å…±æœ‰ ğŸ“               â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”       â”‚
â”‚  â”‚ğŸ  â”‚ â”‚ğŸš¶â”‚ â”‚ğŸš‰â”‚ â”‚ğŸšƒâ”‚       â”‚
â”‚  â”‚æœª â”‚ â”‚å®¶ â”‚ â”‚é§… â”‚ â”‚é›» â”‚       â”‚
â”‚  â”‚å‡º â”‚ â”‚ã‚’ â”‚ â”‚åˆ° â”‚ â”‚è»Š â”‚       â”‚
â”‚  â”‚ç™º â”‚ â”‚å‡º â”‚ â”‚ç€ â”‚ â”‚ä¸­ â”‚       â”‚
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜       â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”       â”‚
â”‚  â”‚ğŸ”„â”‚ â”‚â±ï¸â”‚ â”‚âœ…â”‚ â”‚âš ï¸â”‚       â”‚
â”‚  â”‚ä¹— â”‚ â”‚åˆ° â”‚ â”‚åˆ° â”‚ â”‚é… â”‚       â”‚
â”‚  â”‚æ› â”‚ â”‚ç€ â”‚ â”‚ç€ â”‚ â”‚å»¶ â”‚       â”‚
â”‚  â”‚ä¸­ â”‚ â”‚é–“ â”‚ â”‚æ¸ˆ â”‚ â”‚ä¸­ â”‚       â”‚
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜       â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ’¬ ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¡ãƒ³ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¡ãƒ³ãƒãƒ¼ã®çŠ¶æ³ ğŸ‘¥                 â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ‘¤ å±±ç”°å¤ªéƒ               â”‚   â”‚
â”‚  â”‚ ğŸšƒ é›»è»Šä¹—è»Šä¸­              â”‚   â”‚
â”‚  â”‚ ğŸ“ äºˆå®šé€šã‚Š 15:30åˆ°ç€äºˆå®š   â”‚   â”‚
â”‚  â”‚ ğŸ• 2åˆ†å‰æ›´æ–°               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ‘¤ ä½è—¤èŠ±å­               â”‚   â”‚
â”‚  â”‚ ğŸ”„ ä¹—ã‚Šæ›ãˆä¸­              â”‚   â”‚
â”‚  â”‚ âš ï¸ 5åˆ†é…ã‚Œäºˆå®š             â”‚   â”‚
â”‚  â”‚ ğŸ’¬ ã€Œã¡ã‚‡ã£ã¨æ··ã‚“ã§ã¾ã™ã€    â”‚   â”‚
â”‚  â”‚ ğŸ• 1åˆ†å‰æ›´æ–°               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ‘¤ ç”°ä¸­æ¬¡éƒ               â”‚   â”‚
â”‚  â”‚ âœ… åˆ°ç€æ¸ˆã¿                â”‚   â”‚
â”‚  â”‚ ğŸ“ é›†åˆå ´æ‰€ã«ã„ã¾ã™         â”‚   â”‚
â”‚  â”‚ ğŸ’¬ ã€Œå…ˆã«å¸­ç¢ºä¿ã—ã¦ã¾ã™ğŸºã€  â”‚   â”‚
â”‚  â”‚ ğŸ• 5åˆ†å‰æ›´æ–°               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ä»•æ§˜

| æ“ä½œ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ |
|------|------------|--------------|
| **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒƒãƒ—** | å³åº§ã«æ›´æ–° | ãƒãƒ—ãƒ†ã‚£ãƒƒã‚¯ + ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ |
| **ã‚«ã‚¹ã‚¿ãƒ ãƒœã‚¿ãƒ³** | ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º | ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ |
| **é•·æŠ¼ã—** | è©³ç´°æƒ…å ±è¡¨ç¤º | ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º |
| **ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥** | æœ€æ–°æƒ…å ±å–å¾— | ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º |
| **ä½ç½®æƒ…å ±ãƒˆã‚°ãƒ«** | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®š | ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° |

---

## ğŸš¨ åˆ°ç€äºˆå®šæ™‚åˆ»è‡ªå‹•è¨ˆç®—

### è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

```python
class ArrivalTimeCalculator:
    """åˆ°ç€äºˆå®šæ™‚åˆ»ã®è‡ªå‹•è¨ˆç®—"""

    async def calculate_estimated_arrival(
        self,
        event_id: UUID,
        user_id: UUID,
        current_status: str,
        location: Optional[Tuple[float, float]]
    ) -> Optional[datetime]:

        event = await get_event(event_id)

        if current_status == "ON_TRAIN" and location:
            # Google Directions API ã§çµŒè·¯è¨ˆç®—
            route = await self.get_route_to_destination(
                origin=location,
                destination=(event.latitude, event.longitude),
                mode="transit"
            )

            # ç¾åœ¨æ™‚åˆ» + ç§»å‹•æ™‚é–“
            return datetime.utcnow() + timedelta(
                seconds=route.duration_seconds
            )

        elif current_status == "NEAR_ARRIVAL":
            # åˆ°ç€é–“è¿‘ã¯5åˆ†å¾Œã«è¨­å®š
            return datetime.utcnow() + timedelta(minutes=5)

        elif current_status == "ARRIVED":
            # åˆ°ç€æ¸ˆã¿ã¯ç¾åœ¨æ™‚åˆ»
            return datetime.utcnow()

        return None
```

### é…å»¶æ¤œçŸ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

```python
class DelayDetection:
    """é…å»¶ã®è‡ªå‹•æ¤œçŸ¥"""

    async def detect_delay(self, event_id: UUID, user_id: UUID):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é…å»¶ã‚’è‡ªå‹•æ¤œçŸ¥"""

        status = await get_current_status(event_id, user_id)
        event = await get_event(event_id)

        # ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹æ™‚åˆ»ã‚’10åˆ†éãã¦ã‚‚æœªåˆ°ç€
        if (datetime.utcnow() > event.event_datetime + timedelta(minutes=10)
            and status.status_type != "ARRIVED"):

            # è‡ªå‹•çš„ã«é…å»¶çŠ¶æ…‹ã«æ›´æ–°
            await self.auto_update_to_delayed(event_id, user_id)

            # ä»–ãƒ¡ãƒ³ãƒãƒ¼ã«é€šçŸ¥
            await send_delay_notification(event_id, user_id)
```

---

## ğŸ”” ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥æˆ¦ç•¥

### é€šçŸ¥ãƒˆãƒªã‚¬ãƒ¼

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ | é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚° | é€šçŸ¥å†…å®¹ |
|-------------|-------------|----------|
| **ARRIVED** | å³æ™‚ | ã€Œâ—¯â—¯ã•ã‚“ãŒåˆ°ç€ã—ã¾ã—ãŸã€ |
| **DELAYED** | å³æ™‚ | ã€Œâ—¯â—¯ã•ã‚“ãŒé…ã‚Œã¦ã„ã¾ã™ã€ |
| **CUSTOMï¼ˆé…å»¶ç³»ï¼‰** | å³æ™‚ | ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º |
| **HOME_DEPARTED** | 30åˆ†å‰ãªã‚‰é€šçŸ¥ | ã€Œâ—¯â—¯ã•ã‚“ãŒå‡ºç™ºã—ã¾ã—ãŸã€ |

### é€šçŸ¥ã®æŠ‘åˆ¶ãƒ«ãƒ¼ãƒ«

```python
class NotificationThrottling:
    """é€šçŸ¥ã‚¹ãƒ‘ãƒ é˜²æ­¢"""

    async def should_send_notification(
        self,
        event_id: UUID,
        user_id: UUID,
        status_type: str
    ) -> bool:

        # åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€šçŸ¥ã¯5åˆ†é–“éš”ã§åˆ¶é™
        last_notification = await get_last_notification(event_id, user_id)
        if last_notification and \
           datetime.utcnow() - last_notification.sent_at < timedelta(minutes=5):
            return False

        # é‡è¦ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯å¸¸ã«é€šçŸ¥
        if status_type in ["ARRIVED", "DELAYED"]:
            return True

        # ãã®ä»–ã¯è¨­å®šã«å¾“ã†
        user_settings = await get_notification_settings(user_id)
        return user_settings.status_updates_enabled
```

---

## ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†æãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹

### åé›†ãƒ¡ãƒˆãƒªã‚¯ã‚¹

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | ç›®çš„ | æ´»ç”¨æ–¹æ³• |
|------------|------|----------|
| **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é »åº¦** | UXæ”¹å–„ | UIé…ç½®ã®æœ€é©åŒ– |
| **åˆ°ç€äºˆæ¸¬ç²¾åº¦** | ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æ”¹å–„ | æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«è¨“ç·´ |
| **ä½ç½®æƒ…å ±å…±æœ‰ç‡** | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­è¨ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®èª¿æ•´ |
| **é…å»¶ç™ºç”Ÿãƒ‘ã‚¿ãƒ¼ãƒ³** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š | äº‹å‰ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ |

### åˆ†æã‚¯ã‚¨ãƒªä¾‹

```sql
-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é »åº¦åˆ†æ
SELECT
    status_type,
    COUNT(*) as update_count,
    AVG(EXTRACT(EPOCH FROM (updated_at - created_at))) as avg_duration
FROM user_statuses
WHERE created_at >= NOW() - INTERVAL '30 days'
GROUP BY status_type
ORDER BY update_count DESC;

-- åˆ°ç€äºˆæ¸¬ç²¾åº¦åˆ†æ
SELECT
    event_id,
    AVG(EXTRACT(EPOCH FROM (
        actual_arrival - estimated_arrival_time
    ))) as prediction_error_seconds
FROM user_statuses
WHERE status_type = 'ARRIVED'
  AND estimated_arrival_time IS NOT NULL
GROUP BY event_id;
```

---

**Next**: [[06-APIè¨­è¨ˆ]] - RESTful API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¨­è¨ˆ