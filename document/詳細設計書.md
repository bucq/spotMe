
## 1. MVP概要

### 開発期間

**3ヶ月（12週間）**

### 開発者プロフィール

- **バックエンド**: Python経験者（FastAPI使用）
- **フロントエンド**: 本格開発は初めて（React Native学習必要）
- **インフラ**: GCPサーバーレスアーキテクチャ

### アーキテクチャ方針

- **完全サーバーレス構成（GCP）**
- **スケーラビリティとコスト最適化**
- **マネージドサービス活用でインフラ管理最小化**

### MVPのコアバリュー

**「グループの集合をスマートに管理し、みんなが迷わず集まれる」**

---

## 2. MVP機能一覧

### ✅ **含む機能（Must Have）**

|機能|優先度|説明|
|---|---|---|
|基本認証・ユーザー管理|P0|電話番号認証、プロフィール管理|
|グループ作成・招待|P0|最大10人までのグループ、招待リンク|
|イベント作成・管理|P0|日時・場所設定、出欠確認|
|基本経路探索|P0|Google Directions API活用|
|**詳細ステータス管理**|P0|プリセット8種類+カスタム、リアルタイム同期|
|リアルタイム位置情報共有|P1|Cloud Firestore活用|
|グループチャット|P1|テキストメッセージ、クイック返信|
|プッシュ通知|P1|Firebase Cloud Messaging|

### ❌ **含まない機能（Phase 2以降）**

- 自動目覚まし機能
- AR案内機能
- 天気連動機能
- プレミアム機能
- 過去イベント履歴・分析

---

## 3. GCPサーバーレスアーキテクチャ

### 3.1 システム構成図

```
[モバイルアプリ]
    │
    ├─── REST API ────────> [Cloud Run - FastAPI]
    │                            │
    │                            ├──> [Cloud SQL - PostgreSQL]
    │                            ├──> [Secret Manager]
    │                            └──> [Cloud Storage]
    │
    ├─── リアルタイムDB ───> [Cloud Firestore]
    │                            │
    │                            └──> リアルタイムステータス同期
    │
    ├─── プッシュ通知 ────> [Firebase Cloud Messaging]
    │
    └─── 画像アップロード ─> [Cloud Storage]

[バックグラウンド処理]
    └──> [Cloud Functions]
         ├── 定期的な通知送信
         ├── イベント終了後のクリーンアップ
         └── 位置情報の自動OFF処理
```

### 3.2 使用GCPサービス詳細

#### **Cloud Run（FastAPIホスティング）**

- **役割**: RESTful APIサーバー
- **スケーリング**: 自動（0→1000インスタンス）
- **リージョン**: asia-northeast1（東京）
- **メモリ**: 512MB～2GB
- **CPU**: 1vCPU
- **同時実行数**: 最大80リクエスト/インスタンス

#### **Cloud SQL（PostgreSQL 15）**

- **役割**: メインデータベース
- **マシンタイプ**: db-f1-micro（開発）→ db-n1-standard-1（本番）
- **ストレージ**: 10GB SSD（自動拡張有効）
- **バックアップ**: 自動日次バックアップ
- **Private IP**: Cloud Run接続用

#### **Cloud Firestore**

- **役割**: リアルタイムステータス同期
- **モード**: Native Mode
- **リージョン**: asia-northeast1
- **データ構造**:
    - events/{eventId}/statuses/{userId}
    - events/{eventId}/messages/{messageId}

#### **Cloud Storage**

- **役割**: ユーザー画像、イベント画像保存
- **バケット**: spotMe-user-images, spotMe-event-images
- **ストレージクラス**: Standard
- **ライフサイクル**: 90日後にColdlineに移行

#### **Cloud Functions（第2世代）**

- **役割**: バックグラウンドタスク
- **トリガー**:
    - Pub/Sub（定期実行）
    - Firestore（データ変更）
    - Cloud Scheduler（cron）
- **使用例**:
    - イベント1時間前の通知配信
    - 位置情報の自動OFF（集合時間+5時間後）
    - 未使用データの定期削除

#### **Secret Manager**

- **役割**: 機密情報の安全な保管
- **管理対象**:
    - Google Maps API Key
    - JWT Secret Key
    - Firebase Admin SDK認証情報
    - データベース接続情報

#### **Firebase Cloud Messaging**

- **役割**: プッシュ通知配信
- **通知種類**:
    - イベント招待
    - 出欠確認リマインダー
    - メンバーステータス変更
    - チャットメッセージ

---

## 4. 技術スタック（最新版 2025年）

### 4.1 バックエンド

|カテゴリ|技術|バージョン|用途|
|---|---|---|---|
|フレームワーク|FastAPI|0.115.0|REST API|
|ASGI Server|Uvicorn|0.32.0|非同期サーバー|
|ORM|SQLAlchemy|2.0.36|データベースORM|
|バリデーション|Pydantic|2.9.2|データバリデーション|
|マイグレーション|Alembic|1.14.0|DBスキーマ管理|
|認証|Python-JOSE|3.3.0|JWT認証|
|HTTP Client|HTTPX|0.27.2|外部API呼び出し|
|GCP SDK|google-cloud-*|最新|GCPサービス連携|

### 4.2 フロントエンド

|カテゴリ|技術|バージョン|用途|
|---|---|---|---|
|フレームワーク|React Native|0.76.1|モバイルアプリ|
|言語|TypeScript|5.7.2|型安全性|
|ナビゲーション|React Navigation|7.0.0|画面遷移|
|地図|React Native Maps|1.18.0|マップ表示|
|位置情報|Geolocation Service|5.3.1|GPS取得|
|HTTP|Axios|1.7.9|API通信|
|データ取得|TanStack Query|5.62.0|キャッシュ管理|
|状態管理|Zustand|5.0.2|グローバル状態|
|Firebase|RN Firebase|21.3.0|プッシュ通知|

---

## 5. データベース設計

### 5.1 ER図

```
Users ──────< GroupMembers >────── Groups
  │                                   │
  │                                   │
  └───< Events >──────────────────────┘
        │
        ├───< EventParticipants
        │
        ├───< UserStatuses (詳細ステータス)
        │
        └───< Messages
```

### 5.2 主要テーブル定義

#### **users（ユーザー）**

|カラム|型|制約|説明|
|---|---|---|---|
|id|UUID|PK|ユーザーID|
|phone_number|VARCHAR(20)|UNIQUE, NOT NULL|電話番号|
|name|VARCHAR(100)|NOT NULL|ユーザー名|
|profile_image|VARCHAR(255)|NULL|プロフィール画像URL|
|created_at|TIMESTAMP|NOT NULL|作成日時|
|last_active_at|TIMESTAMP|NULL|最終アクティブ|

#### **groups（グループ）**

|カラム|型|制約|説明|
|---|---|---|---|
|id|UUID|PK|グループID|
|name|VARCHAR(100)|NOT NULL|グループ名|
|created_by|UUID|FK(users.id)|作成者|
|invite_code|VARCHAR(10)|UNIQUE|招待コード|
|created_at|TIMESTAMP|NOT NULL|作成日時|

#### **events（イベント）**

|カラム|型|制約|説明|
|---|---|---|---|
|id|UUID|PK|イベントID|
|group_id|UUID|FK(groups.id)|グループID|
|title|VARCHAR(200)|NOT NULL|イベント名|
|event_datetime|TIMESTAMP|NOT NULL|開催日時|
|location_name|VARCHAR(200)|NOT NULL|場所名|
|location_address|TEXT|NULL|住所|
|latitude|DECIMAL(10,8)|NULL|緯度|
|longitude|DECIMAL(11,8)|NULL|経度|
|created_by|UUID|FK(users.id)|作成者|
|created_at|TIMESTAMP|NOT NULL|作成日時|

#### **user_statuses（詳細ステータス）** ⭐ NEW

|カラム|型|制約|説明|
|---|---|---|---|
|id|UUID|PK|ステータスID|
|event_id|UUID|FK(events.id)|イベントID|
|user_id|UUID|FK(users.id)|ユーザーID|
|status_type|VARCHAR(50)|NOT NULL|ステータス種類|
|custom_message|TEXT|NULL|カスタムメッセージ|
|estimated_arrival_time|TIMESTAMP|NULL|到着予定時刻|
|is_on_schedule|BOOLEAN|DEFAULT TRUE|予定通りか|
|latitude|VARCHAR(50)|NULL|現在地緯度（暗号化）|
|longitude|VARCHAR(50)|NULL|現在地経度（暗号化）|
|updated_at|TIMESTAMP|NOT NULL|更新日時|
|created_at|TIMESTAMP|NOT NULL|作成日時|

**インデックス**:

- `idx_user_statuses_event_user` (event_id, user_id) - UNIQUE
- `idx_user_statuses_updated` (updated_at)

### 5.3 Firestoreコレクション設計

#### **リアルタイムステータス**

```
events/{eventId}
  └── statuses/{userId}
      ├── status_type: string
      ├── custom_message: string?
      ├── user_name: string
      ├── updated_at: timestamp
      └── is_on_schedule: boolean

events/{eventId}
  └── messages/{messageId}
      ├── user_id: string
      ├── user_name: string
      ├── content: string
      ├── type: "text" | "status"
      └── created_at: timestamp
```

**セキュリティルール**:

- イベント参加者のみ読み書き可能
- 自分のステータスのみ更新可能

---

## 6. 詳細ステータス管理機能設計

### 6.1 ステータス種類定義

|ステータス|キー|アイコン|説明|位置情報|
|---|---|---|---|---|
|未出発|NOT_STARTED|🏠|まだ家にいる|不要|
|家を出た|HOME_DEPARTED|🚶|家を出発した|任意|
|駅到着|STATION_ARRIVED|🚉|最寄り駅に到着|任意|
|電車乗車中|ON_TRAIN|🚃|電車に乗っている|任意|
|乗り換え中|TRANSFERRING|🔄|乗り換え駅にいる|任意|
|到着間近|NEAR_ARRIVAL|⏱️|もうすぐ到着|任意|
|到着済み|ARRIVED|✅|集合場所に到着|自動ON|
|遅延中|DELAYED|⚠️|遅れている|任意|
|カスタム|CUSTOM|💬|自由入力|任意|

### 6.2 ステータス更新フロー

```
[ユーザー操作]
    │
    ├── プリセットステータス選択
    │   └──> FastAPI POST /status/{event_id}
    │        └──> Cloud SQL更新
    │             └──> Firestore同期
    │                  └──> 他ユーザーにリアルタイム反映
    │
    └── カスタムステータス入力
        └──> モーダル表示
             └──> メッセージ入力（最大200文字）
                  └──> FastAPI POST /status/{event_id}
                       └──> 同上の処理
```

### 6.3 リアルタイム同期戦略

#### **データフロー**

1. **ステータス更新**: REST API → Cloud SQL（永続化）
2. **リアルタイム配信**: Cloud SQL → Firestore（同期）
3. **クライアント受信**: Firestore Listener → アプリUI更新

#### **同期タイミング**

- ステータス変更: 即時同期
- 位置情報更新: 30秒ごと（バッテリー考慮）
- オフライン対応: Firestore自動キャッシュ

### 6.4 位置情報プライバシー制御

#### **位置情報共有ルール**

|状況|位置情報|ステータス表示|
|---|---|---|
|イベント開始2時間前まで|OFF|「未出発」のみ|
|イベント開始2時間前～終了|ユーザー選択可|詳細ステータス表示|
|「到着済み」選択時|自動ON|正確な位置表示|
|イベント終了+5時間後|強制OFF|表示終了|

#### **位置情報精度レベル**

- **OFF**: ステータスのみ表示（位置情報なし）
- **低精度**: 区レベル（半径500m）
- **中精度**: 駅・停留所レベル（半径100m）
- **高精度**: GPS正確な位置（±10m）

---

## 7. API設計

### 7.1 エンドポイント一覧

#### **認証系**

|Method|Endpoint|説明|認証|
|---|---|---|---|
|POST|/api/auth/register|ユーザー登録|不要|
|POST|/api/auth/verify|SMS認証|不要|
|POST|/api/auth/login|ログイン|不要|
|GET|/api/auth/me|自分の情報取得|必要|

#### **ユーザー系**

|Method|Endpoint|説明|認証|
|---|---|---|---|
|GET|/api/users/{user_id}|ユーザー情報取得|必要|
|PUT|/api/users/profile|プロフィール更新|必要|
|POST|/api/users/profile/image|画像アップロード|必要|

#### **グループ系**

|Method|Endpoint|説明|認証|
|---|---|---|---|
|POST|/api/groups|グループ作成|必要|
|GET|/api/groups|グループ一覧|必要|
|GET|/api/groups/{group_id}|グループ詳細|必要|
|POST|/api/groups/{group_id}/join|グループ参加|必要|
|GET|/api/groups/{group_id}/members|メンバー一覧|必要|

#### **イベント系**

|Method|Endpoint|説明|認証|
|---|---|---|---|
|POST|/api/events|イベント作成|必要|
|GET|/api/events|イベント一覧|必要|
|GET|/api/events/{event_id}|イベント詳細|必要|
|PUT|/api/events/{event_id}|イベント更新|必要|
|POST|/api/events/{event_id}/attend|出欠登録|必要|

#### **ステータス系** ⭐ NEW

|Method|Endpoint|説明|認証|
|---|---|---|---|
|POST|/api/status/{event_id}|ステータス更新|必要|
|GET|/api/status/{event_id}|全員のステータス取得|必要|
|GET|/api/status/{event_id}/me|自分のステータス取得|必要|
|GET|/api/status/presets|プリセット一覧|必要|

#### **経路系**

|Method|Endpoint|説明|認証|
|---|---|---|---|
|GET|/api/routes/calculate|経路計算|必要|
|POST|/api/routes/{event_id}/save|経路保存|必要|

#### **位置情報系**

|Method|Endpoint|説明|認証|
|---|---|---|---|
|POST|/api/location/{event_id}/share|位置情報共有設定|必要|
|GET|/api/location/{event_id}|全員の位置情報取得|必要|

#### **チャット系**

|Method|Endpoint|説明|認証|
|---|---|---|---|
|POST|/api/chat/{event_id}/messages|メッセージ送信|必要|
|GET|/api/chat/{event_id}/messages|メッセージ一覧|必要|

### 7.2 リクエスト/レスポンス例

#### **ステータス更新API**

**リクエスト**:

```http
POST /api/status/{event_id}
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "status_type": "ON_TRAIN",
  "custom_message": null,
  "latitude": 35.681236,
  "longitude": 139.767125
}
```

**レスポンス**:

```http
200 OK
Content-Type: application/json

{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "123e4567-e89b-12d3-a456-426614174000",
  "user_name": "山田太郎",
  "event_id": "789e0123-e45b-67c8-d901-234567890abc",
  "status_type": "ON_TRAIN",
  "custom_message": null,
  "estimated_arrival_time": "2025-09-29T15:30:00Z",
  "is_on_schedule": true,
  "updated_at": "2025-09-29T15:00:00Z"
}
```

---

## 8. UI/UX設計

### 8.1 主要画面一覧

|画面名|優先度|主な機能|
|---|---|---|
|スプラッシュ|P0|アプリ起動画面|
|ログイン/登録|P0|電話番号認証|
|ホーム|P0|グループ・イベント一覧|
|グループ作成|P0|グループ情報入力|
|グループ詳細|P0|メンバー、イベント表示|
|イベント作成|P0|イベント情報入力|
|イベント詳細|P0|出欠、経路、チャット|
|**ステータス画面**|P0|ステータス選択・表示 ⭐|
|経路表示|P1|Google Maps連携|
|リアルタイムマップ|P1|メンバー位置表示|
|チャット|P1|グループメッセージング|
|プロフィール|P1|ユーザー情報編集|

### 8.2 ステータス画面設計

#### **レイアウト構成**

```
┌─────────────────────────────┐
│  ← イベント名                │ ← ヘッダー
├─────────────────────────────┤
│  現在の状況を共有            │
│  ┌───┐ ┌───┐ ┌───┐ ┌───┐  │
│  │🏠 │ │🚶│ │🚉│ │🚃│  │ ← ステータス選択
│  │未 │ │家 │ │駅 │ │電 │  │
│  │出 │ │を │ │到 │ │車 │  │
│  │発 │ │出 │ │着 │ │中 │  │
│  └───┘ └───┘ └───┘ └───┘  │
│  ← スクロール可能 →          │
├─────────────────────────────┤
│  メンバーの状況              │
│  ┌─────────────────────┐   │
│  │ 👤 山田太郎          │   │
│  │ 🚃 電車乗車中         │   │
│  │ 📍 予定通り          │   │
│  │ ⏰ 15:30到着予定     │   │
│  │ 🕐 2分前更新         │   │
│  └─────────────────────┘   │
│  ┌─────────────────────┐   │
│  │ 👤 佐藤花子          │   │
│  │ 🔄 乗り換え中         │   │
│  │ ⚠️ 5分遅れ予定        │   │
│  │ 💬 「ちょっと混んでます」│  │
│  │ 🕐 1分前更新         │   │
│  └─────────────────────┘   │
└─────────────────────────────┘
```

#### **インタラクション**

- **ステータスタップ**: 即座に更新、Firestore経由で他メンバーに配信
- **カスタムボタン**: モーダル表示、メッセージ入力
- **長押し**: 詳細情報表示（経路、予定時刻など）
- **プルリフレッシュ**: 最新情報取得

---

## 9. 非機能要件

### 9.1 パフォーマンス

|項目|目標値|測定方法|
|---|---|---|
|API応答時間|< 500ms|Cloud Monitoring|
|ステータス同期遅延|< 2秒|Firestore latency|
|アプリ起動時間|< 3秒|Performance monitoring|
|画像読み込み|< 1秒|Network inspector|

### 9.2 可用性

|項目|目標値|実現方法|
|---|---|---|
|サービス稼働率|99.9%|Cloud Run auto-healing|
|データベース可用性|99.95%|Cloud SQL HA構成|
|バックアップ|日次|自動バックアップ|
|災害復旧|RPO < 1時間|Point-in-time recovery|

### 9.3 スケーラビリティ

|項目|初期|スケール後|
|---|---|---|
|同時接続ユーザー|100|10,000+|
|API リクエスト/秒|10|1,000+|
|Cloud Run インスタンス|1|自動スケール|
|Firestore 読み取り/秒|100|10,000+|

### 9.4 セキュリティ

|項目|実装方法|
|---|---|
|認証|JWT (RS256) + Firebase Auth|
|通信暗号化|HTTPS (TLS 1.3)|
|データ暗号化|Cloud SQL at-rest encryption|
|位置情報保護|AES-256暗号化、限定公開|
|API Rate Limiting|Cloud Armor|
|DDoS対策|Cloud Load Balancer|

---

## 10. 開発スケジュール

### Week 1-2: 環境構築・基盤開発

- **バックエンド**:
    - GCP プロジェクト作成
    - Cloud Run / Cloud SQL セットアップ
    - FastAPI プロジェクト構築
    - 認証システム実装
- **フロントエンド**:
    - React Native プロジェクト作成
    - Firebase設定
    - 基本コンポーネント作成

### Week 3-4: コア機能開発

- **バックエンド**:
    - ユーザー・グループAPI
    - イベントAPI
    - データベーススキーマ確定
- **フロントエンド**:
    - 認証画面
    - ホーム画面
    - グループ作成画面

### Week 5-6: イベント機能

- **バックエンド**:
    - イベント管理API完成
    - 経路探索API（Google Maps連携）
    - Firestore統合
- **フロントエンド**:
    - イベント作成・詳細画面
    - 出欠確認機能

### Week 7-8: ステータス・位置情報機能

- **バックエンド**:
    - 詳細ステータスAPI ⭐
    - 位置情報共有API
    - リアルタイム同期実装
- **フロントエンド**:
    - ステータス選択UI ⭐
    - リアルタイムステータス表示
    - マップ表示

### Week 9-10: チャット・通知機能

- **バックエンド**:
    - チャットAPI
    - プッシュ通知実装
    - Cloud Functions（バックグラウンド処理）
- **フロントエンド**:
    - チャット画面
    - プッシュ通知処理

### Week 11-12: テスト・最適化・リリース準備

- 統合テスト
- パフォーマンステスト
- セキュリティ監査
- App Store / Google Play 申請準備
- ドキュメント作成

---

## 11. コスト見積もり（月額）

### 11.1 初期フェーズ（~1,000ユーザー）

|サービス|使用量|月額コスト|
|---|---|---|
|Cloud Run|100万リクエスト|$0 (無料枠)|
|Cloud SQL|db-f1-micro|¥2,500|
|Cloud Firestore|5万読み取り|$0 (無料枠)|
|Cloud Storage|10GB|¥300|
|Firebase (FCM)|10万通知|$0 (無料)|
|Cloud Functions|10万実行|$0 (無料枠)|
|**合計**|-|**約¥3,000/月**|

### 11.2 成長フェーズ（~10,000ユーザー）

|サービス|使用量|月額コスト|
|---|---|---|
|Cloud Run|1,000万リクエスト|¥5,000|
|Cloud SQL|db-n1-standard-1|¥15,000|
|Cloud Firestore|500万読み取り/書き込み|¥8,000|
|Cloud Storage|100GB|¥3,000|
|Firebase (FCM)|100万通知|$0 (無料)|
|Cloud Functions|100万実行|¥2,000|
|Cloud Load Balancer|転送量|¥3,000|
|**合計**|-|**約¥36,000/月**|

### 11.3 コスト最適化戦略

- 無料枠の最大活用
- Cloud SQL接続プーリング
- Firestore読み取りキャッシュ
- 画像CDN活用（Cloud CDN）
- 不要データの定期削除

---

## 12. 品質保証・テスト戦略

### 12.1 テスト種類

#### **バックエンドテスト**

|テスト種類|フレームワーク|カバレッジ目標|
|---|---|---|
|単体テスト|pytest|80%以上|
|統合テスト|pytest + TestClient|主要API全て|
|E2Eテスト|Postman/Newman|クリティカルパス|
|負荷テスト|Locust|1,000 req/s|

#### **フロントエンドテスト**

|テスト種類|フレームワーク|カバレッジ目標|
|---|---|---|
|単体テスト|Jest|70%以上|
|コンポーネントテスト|React Testing Library|主要コンポーネント|
|E2Eテスト|Detox|主要フロー全て|
|手動テスト|実機|iOS/Android各3機種|

### 12.2 テストシナリオ（主要）

#### **ステータス更新フロー**

1. ログイン → イベント詳細画面
2. ステータス選択（プリセット）
3. Firestore同期確認
4. 他ユーザー画面に即座反映
5. カスタムメッセージ入力
6. 位置情報ON/OFF切り替え

#### **リアルタイム同期テスト**

1. 複数デバイス同時接続
2. ステータス更新
3. 2秒以内の同期確認
4. オフライン → オンライン復帰
5. データ整合性確認

### 12.3 継続的インテグレーション

```
GitHub Push
    ↓
Cloud Build トリガー
    ↓
├── バックエンドテスト実行
│   ├── Lint（Ruff）
│   ├── Type Check（mypy）
│   ├── Unit Tests（pytest）
│   └── Integration Tests
│
├── フロントエンドテスト実行
│   ├── Lint（ESLint）
│   ├── Type Check（TypeScript）
│   └── Unit Tests（Jest）
│
└── 成功時
    └── Cloud Run自動デプロイ（staging環境）
```

---

## 13. モニタリング・運用

### 13.1 監視項目

#### **アプリケーションメトリクス**

|項目|しきい値|アラート|
|---|---|---|
|API応答時間|> 1秒|Slack通知|
|エラー率|> 1%|Slack通知|
|Cloud Run CPU使用率|> 80%|自動スケール|
|Cloud SQL接続数|> 80%|Slack通知|

#### **ビジネスメトリクス**

|項目|計測方法|
|---|---|
|DAU/MAU|Firestore Analytics|
|イベント作成数|カスタムメトリクス|
|ステータス更新頻度|カスタムメトリクス|
|チャットメッセージ数|カスタムメトリクス|
|プッシュ通知開封率|Firebase Analytics|

### 13.2 ログ管理

#### **構造化ログ**

- **Cloud Logging**に集約
- JSON形式でログ出力
- リクエストID追跡
- エラースタックトレース

#### **ログレベル**

- **DEBUG**: 開発環境のみ
- **INFO**: 主要処理の開始/終了
- **WARNING**: 予期しないが継続可能な状態
- **ERROR**: 処理失敗、要対応
- **CRITICAL**: システム停止レベル

### 13.3 アラート設定

|アラート種類|条件|通知先|
|---|---|---|
|サービスダウン|5xx エラー率 > 5%|Slack（即座）|
|レイテンシ悪化|P95 > 2秒|Slack（5分後）|
|データベース異常|接続エラー > 10回/分|Slack（即座）|
|ディスク使用率|> 90%|Email + Slack|

---

## 14. セキュリティ設計

### 14.1 認証・認可フロー

```
[ユーザー]
    ↓ 電話番号入力
[FastAPI]
    ↓ SMS送信
[外部SMS API]
    ↓ 認証コード入力
[FastAPI]
    ↓ 検証成功
    ↓ JWT発行（RS256）
[ユーザー]
    ↓ 以降のリクエスト
    ↓ Authorization: Bearer {token}
[FastAPI]
    ↓ JWT検証
    ↓ ユーザー識別
[保護されたリソース]
```

### 14.2 データ保護

#### **個人情報保護**

|データ種類|保護方法|
|---|---|
|電話番号|ハッシュ化（bcrypt）|
|位置情報|AES-256暗号化|
|プロフィール画像|Cloud Storage署名付きURL|
|チャット履歴|7日間で自動削除|

#### **アクセス制御**

- **グループ**: メンバーのみアクセス可
- **イベント**: 参加者のみアクセス可
- **ステータス**: イベント参加者のみ閲覧可
- **位置情報**: 本人+イベント参加者のみ

### 14.3 脆弱性対策

|脆弱性|対策|
|---|---|
|SQLインジェクション|SQLAlchemy ORM使用|
|XSS|React自動エスケープ|
|CSRF|トークンベース認証|
|中間者攻撃|HTTPS強制|
|レートリミット|Cloud Armor設定|
|機密情報漏洩|Secret Manager使用|

---

## 15. データ移行・バックアップ戦略

### 15.1 バックアップ方針

#### **Cloud SQL**

- **自動バックアップ**: 毎日午前3時（JST）
- **保持期間**: 7日間
- **バイナリログ**: 有効（Point-in-time Recovery）
- **リージョン**: マルチリージョン

#### **Cloud Firestore**

- **自動エクスポート**: 毎日午前4時
- **エクスポート先**: Cloud Storage
- **保持期間**: 30日間

#### **Cloud Storage（画像）**

- **ライフサイクル管理**: 30日後にNearline
- **バージョニング**: 有効
- **削除保護**: 論理削除（90日間復元可能）

### 15.2 災害復旧計画（DR）

|項目|目標値|実現方法|
|---|---|---|
|RTO（復旧時間目標）|4時間|自動フェイルオーバー|
|RPO（データ損失許容）|1時間|継続的バックアップ|
|リージョン障害対応|24時間|マルチリージョン構成|

---

## 16. スケーリング戦略

### 16.1 水平スケーリング

#### **Cloud Run**

- **自動スケーリング**: 有効
- **最小インスタンス**: 1（コールドスタート回避）
- **最大インスタンス**: 100
- **同時実行数**: インスタンス当たり80

#### **Cloud SQL**

- **リードレプリカ**: 負荷に応じて追加
- **接続プーリング**: PgBouncer導入
- **クエリキャッシュ**: Redis活用

### 16.2 垂直スケーリング

|ユーザー数|Cloud Run|Cloud SQL|
|---|---|---|
|~1,000|512MB / 1vCPU|db-f1-micro|
|~10,000|1GB / 1vCPU|db-n1-standard-1|
|~50,000|2GB / 2vCPU|db-n1-standard-2|
|100,000+|4GB / 4vCPU|db-n1-standard-4|

### 16.3 キャッシュ戦略

#### **アプリケーションレベル**

- **ユーザー情報**: 5分間キャッシュ
- **グループ情報**: 10分間キャッシュ
- **経路情報**: 1時間キャッシュ

#### **CDNキャッシュ（Cloud CDN）**

- **プロフィール画像**: 1日間
- **静的アセット**: 7日間

---

## 17. リリース戦略

### 17.1 段階的ロールアウト

#### **Phase 1: クローズドベータ（Week 11）**

- **対象**: 開発チーム + 友人（20人）
- **期間**: 1週間
- **目的**: 重大バグ発見、使い勝手検証

#### **Phase 2: オープンベータ（Week 12）**

- **対象**: TestFlight / Google Play Beta（100人）
- **期間**: 2週間
- **目的**: 負荷テスト、フィードバック収集

#### **Phase 3: 正式リリース（Week 13-14）**

- **対象**: 一般ユーザー
- **App Store / Google Play**: 同時リリース
- **プロモーション**: SNS、プレスリリース

### 17.2 フィーチャーフラグ

```
新機能リリース時の制御
    ↓
Firestoreに機能フラグ保存
    ↓
├── カナリアリリース（5%）
├── 段階的展開（25% → 50% → 100%）
└── 問題発生時は即座にロールバック
```

---

## 18. 成功指標（KPI）

### 18.1 ユーザー指標

|KPI|目標（3ヶ月後）|測定方法|
|---|---|---|
|登録ユーザー数|1,000人|Firebase Analytics|
|DAU|300人|Firebase Analytics|
|7日間リテンション|40%|Cohort分析|
|30日間リテンション|25%|Cohort分析|

### 18.2 エンゲージメント指標

|KPI|目標|測定方法|
|---|---|---|
|イベント作成数|500件/月|カスタムメトリクス|
|ステータス更新回数|5回/イベント/人|カスタムメトリクス|
|チャット送信数|10件/イベント|カスタムメトリクス|
|位置情報共有率|60%|カスタムメトリクス|

### 18.3 技術指標

|KPI|目標|測定方法|
|---|---|---|
|アプリクラッシュ率|< 0.5%|Firebase Crashlytics|
|API成功率|> 99.5%|Cloud Monitoring|
|平均応答時間|< 300ms|Cloud Monitoring|
|ステータス同期遅延|< 2秒|カスタムメトリクス|

---

## 19. リスク管理

### 19.1 技術リスク

|リスク|影響度|発生確率|対策|
|---|---|---|---|
|Google Maps API制限超過|高|中|キャッシュ活用、代替API準備|
|Firestore同期遅延|中|低|フォールバック機能実装|
|Cloud Run コールドスタート|中|中|最小インスタンス1に設定|
|データベース接続枯渇|高|低|接続プーリング、監視強化|

### 19.2 ビジネスリスク

|リスク|影響度|発生確率|対策|
|---|---|---|---|
|ユーザー獲得不振|高|中|SNSマーケティング、紹介機能|
|競合サービス登場|中|高|独自機能強化、UX改善|
|プライバシー懸念|高|中|透明性確保、設定柔軟化|
|インフラコスト増大|中|中|コスト監視、最適化実施|

### 19.3 法務リスク

|リスク|対策|
|---|---|
|個人情報保護法違反|プライバシーポリシー整備、同意取得|
|位置情報規制|利用目的明示、最小限の取得|
|未成年保護|年齢確認、保護者同意機能|

---

## 20. 今後の展開（Post-MVP）

### 20.1 Phase 2（6ヶ月後）

#### **新機能**

- 自動目覚まし機能
- 天気連動の服装提案
- 交通遅延時の自動経路再計算
- AR案内機能（実験的）
- 画像・音声メッセージ

#### **技術改善**

- GraphQL導入検討
- プッシュ通知最適化
- オフライン対応強化
- パフォーマンス改善

### 20.2 Phase 3（12ヶ月後）

#### **マネタイズ**

- プレミアムプラン導入（月額480円）
    - 無制限グループ作成
    - 高度な分析機能
    - 広告非表示
    - カスタムテーマ

#### **機能拡張**

- 企業向けプラン
- イベント統計・分析
- AIによる最適化提案
- 海外展開（英語・中国語対応）

### 20.3 技術的進化

#### **アーキテクチャ改善**

- マイクロサービス化検討
- gRPC導入
- Kubernetes移行検討
- Edge Computing活用

#### **AI/ML活用**

- 到着時刻予測の精度向上
- 最適経路のパーソナライズ
- 異常検知（遅延予測）
- チャットボット導入

---

## 21. 開発体制

### 21.1 推奨チーム構成

|役割|人数|スキル要件|
|---|---|---|
|バックエンド開発|1-2名|Python, FastAPI, GCP|
|フロントエンド開発|1-2名|React Native, TypeScript|
|UI/UXデザイナー|1名|Figma, モバイルデザイン|
|QAエンジニア|0.5名|テスト自動化|
|プロダクトマネージャー|1名|要件定義、優先順位付け|

### 21.2 開発フロー

```
要件定義
    ↓
設計レビュー
    ↓
実装（2週間スプリント）
    ↓
コードレビュー
    ↓
テスト（自動 + 手動）
    ↓
Staging環境デプロイ
    ↓
受け入れテスト
    ↓
Production環境デプロイ
    ↓
監視・フィードバック収集
```

### 21.3 コミュニケーション

- **日次**: 朝会（15分、進捗共有）
- **週次**: スプリントレビュー、振り返り
- **ツール**: Slack（チャット）、GitHub（コード管理）、Notion（ドキュメント）

---

## 22. ドキュメント管理

### 22.1 必要ドキュメント

|ドキュメント|更新頻度|担当|
|---|---|---|
|API仕様書|機能追加時|バックエンド|
|データベース設計書|スキーマ変更時|バックエンド|
|UI/UX設計書|デザイン変更時|デザイナー|
|運用マニュアル|月次|全員|
|ユーザーマニュアル|リリース前|PM|
|プライバシーポリシー|初回 + 法改正時|PM + 法務|
|利用規約|初回 + 重要変更時|PM + 法務|

---

## 23. まとめ

### 23.1 MVP成功の鍵

1. **シンプルさの維持**: 機能を詰め込みすぎない
2. **ユーザーフィードバック**: 早期からユーザーの声を聞く
3. **技術的堅実性**: 枯れた技術と新技術のバランス
4. **迅速な改善サイクル**: 週次でのアップデート
5. **詳細ステータス機能**: 差別化要素として磨く

### 23.2 Python開発者へのアドバイス

- **FastAPIは得意分野**: バックエンドに注力
- **React Nativeは段階的に**: 最初は簡単な画面から
- **GCPドキュメント活用**: 公式ドキュメントが充実
- **コミュニティ活用**: Stack Overflow、Discord
- **AIツール活用**: Copilot、ChatGPT等で学習加速

### 23.3 次のステップ

1. **Figmaでモックアップ作成**: UI/UX具体化
2. **GCPプロジェクト作成**: 開発環境構築
3. **最小機能で実装開始**: 認証から着手
4. **週次デモ**: 進捗可視化と早期フィードバック

---

**spotMe MVP - 3ヶ月で実現する、スマートな集合管理アプリ**